function stickyFooter(){var t=$("footer").outerHeight();$("body").css("margin-bottom",t)}function formatSeconds(t){var e=new Date(1970,0,1);return e.setSeconds(t),e.toTimeString().replace(/.*(\d{2}:\d{2}).*/,"$1")}function formatMilliseconds(t){var e=new Date(1970,0,1);return e.setMilliseconds(t),t>36e5?e.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1"):e.toTimeString().replace(/.*(\d{2}:\d{2}).*/,"$1")}function getMsSinceMidnight(t){var e=new Date(t);return t-e.setHours(0,0,0,0)}function streakCalc(t,e,a){return e>t-getMsSinceMidnight(t)?(console.log("You already did one today"),newStreak=a):e>t-getMsSinceMidnight(t)-864e5?(console.log("Streak ++"),newStreak=a+1):newStreak=1}function changeView(t){$("section").hide(),$(".tabs li").removeClass("active"),"#mindfulness"===t||"#analytics"===t||"#info"===t||"#admin"===t?($(t).fadeIn(),$(".tabs").css("visibility","visible"),$(t+"Tab").parent("li").addClass("active")):($(".tabs").css("visibility","hidden"),$(t).fadeIn())}function resetAudioPlayer(){$("#kfAudio").get(0).pause(),$("#kfAudio").attr("src",""),$(".audio-played-time").html("00:00"),$("#audioTotalTime").html("00:00"),$(".audio-progress").css("width","0%"),$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin"),$(".finish-audio").hide()}function checkFrequency(t){var e,a=Object.keys(t).length;if(Object.keys(t).forEach(function(a){e?e<t[a]&&(e=t[a]):e=t[a]}),filteredKeys=Object.keys(t).filter(function(a){return t[a]==e}),filteredKeys.length==a)var i="N/A";else if(filteredKeys.length>1)for(var i="",s=0;s<filteredKeys.length&&(i+=filteredKeys[s],s!==filteredKeys.length-1);s++)i+=", ";else var i=filteredKeys;return i}stickyFooter(),$(window).resize(function(){stickyFooter()});var today=new Date,todayString=today.toDateString();$(".alert-dismiss").click(function(){$(this).parent().fadeOut()}),$("#logInForm").submit(function(t){t.preventDefault(),$("#logInButton").html('<i class="fa fa-spinner fa-spin"></i>');var e=$.trim($("#logInEmail").val()),a=$.trim($("#logInPassword").val());firebase.auth().signInWithEmailAndPassword(e,a).then(function(t){$("#logInEmail").val(""),$("#logInPassword").val(""),$("#logInButton").html("Log In")},function(t){$("#logInButton").html("Log In");var a,i=t.code;"auth/invalid-email"==i?a="Email address incorrectly formatted":"auth/wrong-password"==i?a="Incorrect password. Please try again.":"auth/user-not-found"==i&&(a="A user with email "+e+" does not exist."),$("#logInAlert").stop(!0,!0),$("#logInAlert .alert-message").html(a),$("#logInAlert").fadeIn("fast").delay(6e3).fadeOut("slow"),console.log(i+" "+a)})}),$(".log-out-button").click(function(){resetAudioPlayer(),$(".admin-tabs").hide();firebase.auth().currentUser.email;firebase.auth().signOut().then(function(){changeView("#mindfulness"),$(".mobile-menu").fadeOut()},function(t){console.log("Error! "+errorMessage)})}),$("#forgotPasswordLink").click(function(){$("#logInForm").hide(),$("#forgotPasswordForm").fadeIn()}),$("#forgotBack").click(function(){$("#forgotPasswordForm").hide(),$("#logInForm").fadeIn()}),$("#forgotPasswordForm").submit(function(t){t.preventDefault(),$("#forgotPasswordButton").html('<i class="fa fa-spinner fa-spin"></i>');var e=$.trim($("#forgotPasswordEmail").val());firebase.auth().sendPasswordResetEmail(e).then(function(){$("#forgotPasswordAlert").stop(!0,!0),$("#forgotPasswordAlert .alert-message").html("Password reset email sent to "+e),$("#forgotPasswordButton").html('<i class="fa fa-check"></i>'),$("#forgotPasswordAlert").addClass("alert-success").fadeIn()},function(t){var e=t.message;$("#forgotPasswordAlert").stop(!0,!0),$("#forgotPasswordButton").html("Reset Password"),$("#forgotPasswordAlert .alert-message").html(e),$("#forgotPasswordAlert").fadeIn("fast").delay(6e3).fadeOut("slow")})}),$(".menu-btn").click(function(){$(".mobile-menu").fadeIn()}),$(".close-menu-btn").click(function(){$(".mobile-menu").fadeOut()}),$("#mindfulnessTab").click(function(){changeView("#mindfulness")}),$("#analyticsTab").click(function(){changeView("#analytics")}),$("#infoTab").click(function(){changeView("#info")}),$("#adminTab").click(function(){changeView("#admin")}),$("#moodsBack").click(function(){changeView("#mindfulness")}),$(document).ready(function(){firebase.auth().onAuthStateChanged(function(t){if(t){$(".user-logged-out").hide(),$(".user-logged-in").fadeIn();var e,a,i,s=t.uid,o=firebase.database().ref("users/"+s+"/organisation");o.once("value").then(function(t){a=t.val();const e=firebase.database().ref("/data");e.on("value",function(t){i=t.val(),$(".activity-list").empty(),$(".mood-list").empty(),$.each(i.activities,function(t,e){$.inArray(a,e.tags)>-1&&($.inArray("work",e.tags)>-1?$("#workActivities").append("<li><button id="+e.id+" class='btn btn-outline activity-btn'>"+e.title+"</button></li>"):$.inArray("groupWork",e.tags)>-1?$("#groupActivities").append("<li><button id="+e.id+" class='btn btn-outline activity-btn'>"+e.title+"</button></li>"):$.inArray("personal",e.tags)>-1&&$("#personalActivities").append("<li><button id="+e.id+" class='btn btn-outline activity-btn'>"+e.title+"</button></li>"),$("#infoDescriptions").append("<dt>"+e.title+"</dt><dd>"+e.description+"</dl>"))}),$.each(i.moods,function(t,e){$(".mood-list").append("<button class='mood-btn' id='"+e.id+"'>"+e.name+"</button>")})})});var n=firebase.database().ref("users/"+s);n.on("value",function(t){e=t.val(),$("#historyList").empty(),$(".user-email").html(e.name),"yes"==e.superDuper&&$(".admin-tabs").show(),$("#totalAudioTime").html(formatMilliseconds(e.totalAudioTime)),$("#totalSessions").html(e.totalSessions),$("#streak").html(e.streak),$("#frequentActivity").html(checkFrequency(e.stats.activity)),$("#startingMood").html(checkFrequency(e.stats.startingMood)),$("#endingMood").html(checkFrequency(e.stats.endingMood)),$.each(e.history,function(t,e){var a=e.date,i=new Date(a).toDateString();$("#historyList").append("<tr><td colspan='3'><span class='date-row'>"+i+"</span></td></tr><tr><td>"+e.preMood+"</td><td class='icon-cell'><i class='fa fa-plus'></i></td><td class='activity-cell'>"+e.activity+"</td><td class='icon-cell'><i class='fa fa-arrow-right'></i></td><td>"+e.postMood+"</td></tr>")})});var r,l,d,c,u=$("#kfAudio");$(".activity-list").on("click",".activity-btn",function(){r=$(this).attr("id"),l=$(this).html(),"groupMeeting"==r?(changeView("#audio"),$.each(i.audios,function(t,e){return $.inArray(r,e.tags)>-1?($(".audio-name").html(e.title),$(".audio-total-time").html("<i class='fa fa-sun-o fa-spin'></i>"),$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin"),u.attr("src",e.link),$(".finish-audio").fadeIn(),!1):($(".audio-name").html("Sorry, we've made an error! Try refreshing the page."),void $(".play-pause i").removeClass("fa-pause fa-play fa-sun-o fa-spin").addClass("fa-times"))})):changeView("#moods"),$(".upcoming-activity").html(l)}),$("#preMoodList").on("click",".mood-btn",function(){changeView("#audio"),d=$(this).attr("id"),c=$(this).html(),$.each(i.audios,function(t,e){return $.inArray(r,e.tags)>-1&&$.inArray(d,e.tags)>-1?($(".audio-name").html(e.title),$(".audio-total-time").html("<i class='fa fa-sun-o fa-spin'></i>"),$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin"),u.attr("src",e.link),u.load(),!1):($(".audio-name").html("Sorry, we've made an error! Try refreshing the page."),void $(".play-pause i").removeClass("fa-pause fa-play fa-sun-o fa-spin").addClass("fa-times"))})}),$(".cancel-audio").click(function(){changeView("#mindfulness"),resetAudioPlayer()}),u.on("canplay",function(t){t.stopImmediatePropagation(),$(".audio-total-time").html(formatSeconds(this.duration)),$(".play-pause i").removeClass("fa-sun-o fa-spin fa-pause").addClass("fa-play")}),$(".play-pause").click(function(t){t.preventDefault;var e=u.get(0);0==e.paused?(e.pause(),$(".play-pause i").removeClass("fa-pause fa-rotate-left").addClass("fa-play")):(e.play(),$(".play-pause i").removeClass("fa-play fa-rotate-left").addClass("fa-pause"))}),$(".seekbar").mouseover(function(){$(this).css("cursor","pointer")}),$(".seekbar").click(function(t){var e=u.get(0),a=t.pageX-$(this).offset().left,i=$(this).width(),s=e.duration;e.currentTime=a/i*s}),u.on("timeupdate",function(){$(".audio-played-time").html(formatSeconds(this.currentTime)),$(".audio-progress").width(this.currentTime/this.duration*100+"%")}),u.on("ended",function(){"groupMeeting"!=r?changeView("#postAudioMood"):$(".play-pause i").removeClass("fa-play").addClass("fa-rotate-left")}),$("#postAudioMoodList").on("click",".mood-btn",function(){var a=$(this).html(),i="https://hooks.slack.com/services/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",o="*"+e.name+"* ("+t.email+") just listened to an audio. Activity: _"+l+"_, Starting Mood: _"+c+"_, Finishing mood: _"+a+"_";$.ajax({data:"payload="+JSON.stringify({text:o}),dataType:"json",processData:!1,type:"POST",url:i});var n={},d=u.get(0),f=Date.now(),m=streakCalc(f,e.streakDate,e.streak),g=e.totalAudioTime+1e3*d.duration,p=e.totalSessions+1,h={date:f,preMood:c,activity:l,activityID:r,postMood:a};n["/users/"+s+"/streak"]=m,n["/users/"+s+"/streakDate"]=f,n["/users/"+s+"/totalAudioTime"]=g,n["/users/"+s+"/totalSessions"]=p,n["/users/"+s+"/history/"+f]=h;var y=e.stats;y.startingMood[c]=(y.startingMood[c]||0)+1,y.activity[l]=(y.activity[l]||0)+1,y.endingMood[a]=(y.endingMood[a]||0)+1;try{firebase.database().ref().update(n),firebase.database().ref("/users/"+s+"/stats/").set(y),changeView("#analytics"),resetAudioPlayer()}catch(a){console.log(a);var v="*"+e.name+"* ("+t.email+") encountered the following error: _"+a+"_";$.ajax({data:"payload="+JSON.stringify({text:v}),dataType:"json",processData:!1,type:"POST",url:i})}})}else $(".user-logged-in").hide(),$(".user-logged-out").fadeIn(),s="Nobody!",$(".user-email").html("")})});