function stickyFooter(){var t=$("footer").outerHeight();$("body").css("margin-bottom",t)}function formatSeconds(t){var e=new Date(1970,0,1);return e.setSeconds(t),e.toTimeString().replace(/.*(\d{2}:\d{2}).*/,"$1")}function formatMilliseconds(t){var e=new Date(1970,0,1);return e.setMilliseconds(t),t>36e5?e.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1"):e.toTimeString().replace(/.*(\d{2}:\d{2}).*/,"$1")}function getMsSinceMidnight(t){var e=new Date(t);return t-e.setHours(0,0,0,0)}function streakCalc(t,e,a){return e>t-getMsSinceMidnight(t)?(console.log("You already did one today"),newStreak=a):e>t-getMsSinceMidnight(t)-864e5?(console.log("Streak ++"),newStreak=a+1):newStreak=1}function changeView(t){$("section").hide(),$(".tabs li").removeClass("active"),"#mindfulness"===t||"#analytics"===t||"#info"===t||"#admin"===t?($(t).fadeIn(),$(".tabs").css("visibility","visible"),$(t+"Tab").parent("li").addClass("active")):($(".tabs").css("visibility","hidden"),$(t).fadeIn())}function changeAdminView(t){$(".admin-view").hide(),$("#"+t+"View").fadeIn(),$(".admin-nav .btn").removeClass("active"),$("#"+t+"Btn").addClass("active")}function resetAudioPlayer(){$("#kfAudio").get(0).pause(),$("#kfAudio").attr("src",""),$(".audio-played-time").html("00:00"),$("#audioTotalTime").html("00:00"),$(".audio-progress").css("width","0%"),$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin"),$(".finish-audio").hide()}function checkFrequency(t){var e,a=Object.keys(t).length;if(Object.keys(t).forEach(function(a){e?e<t[a]&&(e=t[a]):e=t[a]}),filteredKeys=Object.keys(t).filter(function(a){return t[a]==e}),filteredKeys.length==a)var i="N/A";else if(filteredKeys.length>1)for(var i="",s=0;s<filteredKeys.length&&(i+=filteredKeys[s],s!==filteredKeys.length-1);s++)i+=", ";else var i=filteredKeys;return i}stickyFooter(),$(window).resize(function(){stickyFooter()});var today=new Date,todayString=today.toDateString();$(".alert-dismiss").click(function(){$(this).parent().fadeOut()}),$("#logInForm").submit(function(t){t.preventDefault(),$("#logInButton").html('<i class="fa fa-spinner fa-spin"></i>');var e=$.trim($("#logInEmail").val()),a=$.trim($("#logInPassword").val());firebase.auth().signInWithEmailAndPassword(e,a).then(function(t){$("#logInEmail").val(""),$("#logInPassword").val(""),$("#logInButton").html("Log In")},function(t){$("#logInButton").html("Log In");var a,i=t.code;"auth/invalid-email"==i?a="Email address incorrectly formatted":"auth/wrong-password"==i?a="Incorrect password. Please try again.":"auth/user-not-found"==i&&(a="A user with email "+e+" does not exist."),$("#logInAlert").stop(!0,!0),$("#logInAlert .alert-message").html(a),$("#logInAlert").fadeIn("fast").delay(6e3).fadeOut("slow"),console.log(i+" "+a)})}),$(".log-out-button").click(function(){resetAudioPlayer(),$(".admin-tabs").hide();firebase.auth().currentUser.email;firebase.auth().signOut().then(function(){changeView("#mindfulness"),$(".mobile-menu").fadeOut()},function(t){console.log("Error! "+errorMessage)})}),$("#forgotPasswordLink").click(function(){$("#logInForm").hide(),$("#forgotPasswordForm").fadeIn()}),$("#forgotBack").click(function(){$("#forgotPasswordForm").hide(),$("#logInForm").fadeIn()}),$("#forgotPasswordForm").submit(function(t){t.preventDefault(),$("#forgotPasswordButton").html('<i class="fa fa-spinner fa-spin"></i>');var e=$.trim($("#forgotPasswordEmail").val());firebase.auth().sendPasswordResetEmail(e).then(function(){$("#forgotPasswordAlert").stop(!0,!0),$("#forgotPasswordAlert .alert-message").html("Password reset email sent to "+e),$("#forgotPasswordButton").html('<i class="fa fa-check"></i>'),$("#forgotPasswordAlert").addClass("alert-success").fadeIn()},function(t){var e=t.message;$("#forgotPasswordAlert").stop(!0,!0),$("#forgotPasswordButton").html("Reset Password"),$("#forgotPasswordAlert .alert-message").html(e),$("#forgotPasswordAlert").fadeIn("fast").delay(6e3).fadeOut("slow")})}),$(".menu-btn").on("click",function(){$(".mobile-menu").fadeIn()}),$(".close-menu-btn").on("click",function(){$(".mobile-menu").fadeOut()}),$("#mindfulnessTab").on("click",function(){changeView("#mindfulness")}),$("#analyticsTab").on("click",function(){changeView("#analytics")}),$("#infoTab").on("click",function(){changeView("#info")}),$("#adminTab").on("click",function(){changeView("#admin")}),$("#moodsBack").on("click",function(){changeView("#mindfulness")}),$("#adminAnalyticsBtn").on("click",function(){changeAdminView("adminAnalytics")}),$("#adminActivitiesBtn").on("click",function(){changeAdminView("adminActivities")}),$("#adminAudiosBtn").on("click",function(){changeAdminView("adminAudios")}),$("#adminGroupsBtn").on("click",function(){changeAdminView("adminGroups")}),$("#adminUsersBtn").on("click",function(){changeAdminView("adminUsers")}),$(document).ready(function(){firebase.auth().onAuthStateChanged(function(t){if(t){$(".user-logged-out").hide(),$(".user-logged-in").fadeIn();var e,a,i,s=t.uid,o=firebase.database().ref("users/"+s+"/organisation");o.once("value").then(function(t){a=t.val();const e=firebase.database().ref("/data");e.on("value",function(t){i=t.val(),$(".activity-list").empty(),$(".mood-list").empty(),$("#infoDescriptions").empty(),$.each(i.activities,function(t,e){$.inArray(a,e.tags)>-1&&($.inArray("work",e.tags)>-1?$("#workActivities").append("<li><button id="+e.id+" class='btn btn-outline activity-btn'>"+e.title+"</button></li>"):$.inArray("groupWork",e.tags)>-1?$("#groupActivities").append("<li><button id="+e.id+" class='btn btn-outline activity-btn'>"+e.title+"</button></li>"):$.inArray("personal",e.tags)>-1&&$("#personalActivities").append("<li><button id="+e.id+" class='btn btn-outline activity-btn'>"+e.title+"</button></li>"),$("#infoDescriptions").append("<dt>"+e.title+"</dt><dd>"+e.description+"</dl>"))}),$.each(i.moods,function(t,e){$(".mood-list").append("<button class='mood-btn' id='"+e.id+"'>"+e.name+"</button>")})})});var n=firebase.database().ref("users/"+s);n.on("value",function(t){e=t.val(),$("#historyList").empty(),$(".user-email").html(e.name),"yes"==e.superDuper?$(".admin-tabs").show():$("#admin").html(""),$("#totalAudioTime").html(formatMilliseconds(e.totalAudioTime)),$("#totalSessions").html(e.totalSessions),$("#streak").html(e.streak),$("#frequentActivity").html(checkFrequency(e.stats.activity)),$("#startingMood").html(checkFrequency(e.stats.startingMood)),$("#endingMood").html(checkFrequency(e.stats.endingMood)),$.each(e.history,function(t,e){var a=e.date,i=new Date(a).toDateString();$("#historyList").append("<tr><td colspan='3'><span class='date-row'>"+i+"</span></td></tr><tr><td>"+e.preMood+"</td><td class='icon-cell'><i class='fa fa-plus'></i></td><td class='activity-cell'>"+e.activity+"</td><td class='icon-cell'><i class='fa fa-arrow-right'></i></td><td>"+e.postMood+"</td></tr>")})});var r,d,l,c,u=$("#kfAudio");$(".activity-list").on("click",".activity-btn",function(){r=$(this).attr("id"),d=$(this).html(),"groupMeeting"==r?(changeView("#audio"),$.each(i.audios,function(t,e){return $.inArray(r,e.tags)>-1?($(".audio-name").html(e.title),$(".audio-total-time").html("<i class='fa fa-sun-o fa-spin'></i>"),$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin"),u.attr("src",e.link),$(".finish-audio").fadeIn(),!1):($(".audio-name").html("Sorry, we've made an error! Try refreshing the page."),void $(".play-pause i").removeClass("fa-pause fa-play fa-sun-o fa-spin").addClass("fa-times"))})):changeView("#moods"),$(".upcoming-activity").html(d)}),$("#preMoodList").on("click",".mood-btn",function(){changeView("#audio"),l=$(this).attr("id"),c=$(this).html(),$.each(i.audios,function(t,e){return $.inArray(r,e.tags)>-1&&$.inArray(l,e.tags)>-1?($(".audio-name").html(e.title),$(".audio-total-time").html("<i class='fa fa-sun-o fa-spin'></i>"),$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin"),u.attr("src",e.link),u.load(),!1):($(".audio-name").html("Sorry, we've made an error! Try refreshing the page."),void $(".play-pause i").removeClass("fa-pause fa-play fa-sun-o fa-spin").addClass("fa-times"))})}),$(".cancel-audio").click(function(){changeView("#mindfulness"),resetAudioPlayer()}),u.on("canplay",function(t){t.stopImmediatePropagation(),$(".audio-total-time").html(formatSeconds(this.duration)),$(".play-pause i").removeClass("fa-sun-o fa-spin fa-pause").addClass("fa-play")}),$(".play-pause").click(function(t){t.preventDefault;var e=u.get(0);0==e.paused?(e.pause(),$(".play-pause i").removeClass("fa-pause fa-rotate-left").addClass("fa-play")):(e.play(),$(".play-pause i").removeClass("fa-play fa-rotate-left").addClass("fa-pause"))}),$(".seekbar").mouseover(function(){$(this).css("cursor","pointer")}),$(".seekbar").click(function(t){var e=u.get(0),a=t.pageX-$(this).offset().left,i=$(this).width(),s=e.duration;e.currentTime=a/i*s}),u.on("timeupdate",function(){$(".audio-played-time").html(formatSeconds(this.currentTime)),$(".audio-progress").width(this.currentTime/this.duration*100+"%")}),u.on("ended",function(){"groupMeeting"!=r?changeView("#postAudioMood"):$(".play-pause i").removeClass("fa-play").addClass("fa-rotate-left")}),$("#postAudioMoodList").on("click",".mood-btn",function(){var a=$(this).html(),i="https://hooks.slack.com/services/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",o="*"+e.name+"* ("+t.email+") just listened to an audio. Activity: _"+d+"_, Starting Mood: _"+c+"_, Finishing mood: _"+a+"_";$.ajax({data:"payload="+JSON.stringify({text:o}),dataType:"json",processData:!1,type:"POST",url:i});var n={},l=u.get(0),f=1e3*l.duration,m=Date.now(),g=streakCalc(m,e.streakDate,e.streak),p=e.totalAudioTime+f,h=e.totalSessions+1,y={date:m,preMood:c,activity:d,activityID:r,postMood:a},v={date:m,uid:s,name:e.name,organisation:e.organisation,preMood:c,activity:d,activityID:r,postMood:a,audioDuration:f};n["/users/"+s+"/streak"]=g,n["/users/"+s+"/streakDate"]=m,n["/users/"+s+"/totalAudioTime"]=p,n["/users/"+s+"/totalSessions"]=h,n["/users/"+s+"/history/"+m]=y,n["/admin/history/"+m]=v;var b=e.stats;b.startingMood[c]=(b.startingMood[c]||0)+1,b.activity[d]=(b.activity[d]||0)+1,b.endingMood[a]=(b.endingMood[a]||0)+1;try{firebase.database().ref().update(n),firebase.database().ref("/users/"+s+"/stats/").set(b)}catch(a){console.log(a);var w="*"+e.name+"* ("+t.email+") encountered the following error: _"+a+"_";$.ajax({data:"payload="+JSON.stringify({text:w}),dataType:"json",processData:!1,type:"POST",url:i})}finally{changeView("#analytics"),resetAudioPlayer()}})}else $(".user-logged-in").hide(),$(".user-logged-out").fadeIn(),s="Nobody!",$(".user-email").html("")})});var adminDBRef=firebase.database().ref("admin");adminDBRef.on("value",function(t){$("#adminAnalyticsLists").empty(),$("#groupsList").empty();var e=t.val();$.each(e.organisations,function(t,e){var a=e.replace(/\s+/g,"");$("#adminAnalyticsLists").append('<div class="tableWrapper" id="'+a+'Analytics"><h3>'+e+"</h3><table><tbody></tbody></table></div>"),$("#groupsList").append("<li>"+e+' <button class="delete-group btn btn-error btn-sm" id="'+t+'"><i class="fa fa-trash-o"></i></button></li>')}),$.each(e.history,function(t,e){var a=new Date(e.date).toDateString(),i=e.organisation;$("#"+i.replace(/\s+/g,"")+"Analytics table tbody").append("<tr><td>"+a+"</td><td>"+i+"</td><td>"+e.name+"</td><td>"+e.preMood+"</td><td>"+e.activity+"</td><td>"+e.postMood+"</td></tr>")}),$(".delete-group").on("click",function(){var t=$(this).attr("id");try{firebase.database().ref("/admin/organisations/"+t).remove()}catch(t){console.log(t)}})});var adminDataRef=firebase.database().ref("data");adminDataRef.on("value",function(t){$("#activitiesTable").empty();var e=t.val();$.each(e.activities,function(t,e){$("#activitiesTable").append("<tr><td>"+e.id+"</td><td>"+e.title+"</td><td>"+e.tags+"</td><td>"+e.description+"</td></tr>")})});var storageRef=firebase.storage().ref(),file;$("#newFile").on("change",function(){return file=this.files[0]}),$("#newAudioForm").on("submit",function(t){var e=$("#newAudioID").val(),a=$("#newAudioTitle").val(),i=$("#newAudioTags").val().replace(/\s+/g,"").split(","),s=storageRef.child(file.name).put(file);return s.on(firebase.storage.TaskEvent.STATE_CHANGED,function(t){var e=t.bytesTransferred/t.totalBytes*100;switch(console.log("Upload is "+e+"% done"),t.state){case firebase.storage.TaskState.progress:console.log("Upload is "+e+"% done");break;case firebase.storage.TaskState.PAUSED:console.log("Upload is paused");break;case firebase.storage.TaskState.RUNNING:console.log("Upload is running")}},function(t){switch(t.code){case"storage/unauthorized":console.log("User doesn't have permission to access the object");break;case"storage/canceled":console.log("User canceled the upload");break;case"storage/unknown":console.log("Unknown error occurred, inspect error.serverResponse")}},function(){var t=s.snapshot.downloadURL;console.log("Successful upload: "+t);var o={id:e,link:t,tags:i,title:a};try{var n=firebase.database().ref("/data/audios/").push().key;firebase.database().ref("/data/audios/"+n).update(o)}catch(t){console.log(t)}finally{$("#newAudioForm").trigger("reset")}}),!1}),$("#addNewGroupForm").on("submit",function(t){var e=$("#newGroupId").val();try{firebase.database().ref("/admin/organisations").push(e)}catch(t){console.log(t)}finally{$("#addNewGroupForm").trigger("reset")}return!1});