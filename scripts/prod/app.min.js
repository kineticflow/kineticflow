$(document).ready(function(){firebase.auth().onAuthStateChanged(function(g){if(!g){$(".user-logged-in").hide();$(".user-logged-out").fadeIn();c="Nobody!";$(".user-email").html("")}else{$(".user-logged-out").hide();$(".user-logged-in").fadeIn();var c=g.uid;var k;var o;var i;var f=firebase.database().ref("users/"+c+"/organisation");f.once("value").then(function(q){o=q.val();const p=firebase.database().ref("/data");p.on("value",function(r){i=r.val();$(".activity-list").empty();$(".mood-list").empty();$.each(i.activities,function(s,t){if($.inArray(o,t.tags)>-1){$(".activity-list").append("<li><button id="+t.id+" class='btn btn-outline activity-btn'>"+t.title+"</button></li>")}});$.each(i.moods,function(s,t){$(".mood-list").append("<li><button class='btn btn-outline mood-btn' id='"+t.id+"'>"+t.name+"</button></li>")})})});var e=firebase.database().ref("users/"+c);e.on("value",function(p){k=p.val();$("#historyList").empty();$(".user-email").html(k.name);$("#totalAudioTime").html(formatMilliseconds(k.totalAudioTime));$("#totalSessions").html(k.totalSessions);$("#streak").html(k.streak);$("#frequentActivity").html(checkFrequency(k.stats.activity));$("#startingMood").html(checkFrequency(k.stats.startingMood));$("#endingMood").html(checkFrequency(k.stats.endingMood));$.each(k.history,function(r,t){var q=t.date;var s=new Date(q).toDateString();$("#historyList").append("<li><p><em>"+s+"</em></p> "+t.preMood+" <i class='fa fa-plus icon-left icon-right'></i> "+t.activity+" <i class='fa fa-arrow-right icon-left icon-right'></i> "+t.postMood+"</li>")})});var a,b,m,l,d;var h=$("#kfAudio");$(".activity-list").on("click",".activity-btn",function(){a=$(this).attr("id");b=$(this).html();changeView("#moods");$(".upcoming-activity").html(b)});$("#preMoodList").on("click",".mood-btn",function(){changeView("#audio");l=$(this).attr("id");d=$(this).html();$.each(i.audios,function(p,q){if($.inArray(a,q.tags)>-1&&$.inArray(l,q.tags)>-1){$(".audio-name").html(q.title);$("#audioTotalTime").html("<i class='fa fa-sun-o fa-spin'></i>");h.attr("src",q.link);return false}else{$(".audio-name").html("Sorry, we've made an error! Try refreshing the page.");$(".play-pause i").removeClass("fa-pause fa-play fa-sun-o fa-spin").addClass("fa-times")}})});$("#cancelAudio").click(function(){changeView("#mindfulness");resetAudioPlayer()});h.on("canplay",function(p){p.stopImmediatePropagation();$("#audioTotalTime").html(formatSeconds(this.duration));$(".play-pause i").removeClass("fa-sun-o fa-spin fa-pause").addClass("fa-play")});$(".play-pause").click(function(q){q.preventDefault;var p=h.get(0);if(p.paused==false){p.pause();$(".play-pause i").removeClass("fa-pause").addClass("fa-play")}else{p.play();$(".play-pause i").removeClass("fa-play").addClass("fa-pause")}});$(".seekbar").mouseover(function(){$(this).css("cursor","pointer")});$(".seekbar").click(function(t){var q=h.get(0);var p=t.pageX-$(this).offset().left;var r=$(this).width();var s=q.duration;q.currentTime=p/r*s});h.on("timeupdate",function(){$("#audioPlayedTime").html(formatSeconds(this.currentTime));$(".audio-progress").width(this.currentTime/this.duration*100+"%")});h.on("ended",function(){changeView("#postAudioMood")});$("#postAudioMoodList").on("click",".mood-btn",function(){var s=$(this).html();var z={};var x=h.get(0);var u=Date.now();var q=streakCalc(u,k.streakDate,k.streak);var p=k.totalAudioTime+x.duration*1000;var v=k.totalSessions+1;var y=new Date;var r={date:u,preMood:d,activity:b,activityID:a,postMood:s};z["/users/"+c+"/streak"]=q;z["/users/"+c+"/streakDate"]=u;z["/users/"+c+"/totalAudioTime"]=p;z["/users/"+c+"/totalSessions"]=v;z["/users/"+c+"/history/"+y]=r;var t=k.stats;t.startingMood[d]=(t.startingMood[d]||0)+1;t.activity[b]=(t.activity[b]||0)+1;t.endingMood[s]=(t.endingMood[s]||0)+1;try{firebase.database().ref().update(z);firebase.database().ref("/users/"+c+"/stats/").set(t);changeView("#analytics");resetAudioPlayer()}catch(w){console.log(w)}})}})});function resetAudioPlayer(){$("#kfAudio").get(0).pause();$("#kfAudio").attr("src","");$("#audioPlayedTime").html("00:00");$("#audioTotalTime").html("00:00");$(".audio-progress").css("width","0%");$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin")}function checkFrequency(e){n=undefined;var c=Object.keys(e).length;Object.keys(e).forEach(function(a){if(!n){n=e[a]}else{if(n<e[a]){n=e[a]}}});j=Object.keys(e).filter(function(a){return e[a]==n});if(j.length==c){var b="N/A"}else{if(j.length>1){var b="";for(var d=0;d<j.length;d++){b+=j[d];if(d===j.length-1){break}else{b+=", "}}}else{var b=j}}return b};