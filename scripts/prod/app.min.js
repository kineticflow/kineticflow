$(document).ready(function(){firebase.auth().onAuthStateChanged(function(g){if(!g){$(".user-logged-in").hide();$(".user-logged-out").fadeIn();c="Nobody!";$(".user-email").html("")}else{$(".user-logged-out").hide();$(".user-logged-in").fadeIn();var c=g.uid;var j;var m;var i;var f=firebase.database().ref("users/"+c+"/organisation");f.once("value").then(function(o){m=o.val();const n=firebase.database().ref("/data");n.on("value",function(p){i=p.val();$(".activity-list").empty();$(".mood-list").empty();$.each(i.activities,function(q,r){if($.inArray(m,r.tags)>-1){if($.inArray("work",r.tags)>-1){$("#workActivities").append("<li><button id="+r.id+" class='btn btn-outline activity-btn'>"+r.title+"</button></li>")}else{if($.inArray("groupWork",r.tags)>-1){$("#groupActivities").append("<li><button id="+r.id+" class='btn btn-outline activity-btn'>"+r.title+"</button></li>")}else{if($.inArray("personal",r.tags)>-1){$("#personalActivities").append("<li><button id="+r.id+" class='btn btn-outline activity-btn'>"+r.title+"</button></li>")}}}$("#infoDescriptions").append("<dt>"+r.title+"</dt><dd>"+r.description+"</dl>")}});$.each(i.moods,function(q,r){$(".mood-list").append("<button class='mood-btn' id='"+r.id+"'>"+r.name+"</button>")})})});var e=firebase.database().ref("users/"+c);e.on("value",function(n){j=n.val();$("#historyList").empty();$(".user-email").html(j.name);if(j.superDuper=="yes"){$(".admin-tabs").show()}$("#totalAudioTime").html(formatMilliseconds(j.totalAudioTime));$("#totalSessions").html(j.totalSessions);$("#streak").html(j.streak);$("#frequentActivity").html(checkFrequency(j.stats.activity));$("#startingMood").html(checkFrequency(j.stats.startingMood));$("#endingMood").html(checkFrequency(j.stats.endingMood));$.each(j.history,function(p,r){var o=r.date;var q=new Date(o).toDateString();$("#historyList").append("<tr><td colspan='3'><span class='date-row'>"+q+"</span></td></tr><tr><td>"+r.preMood+"</td><td class='icon-cell'><i class='fa fa-plus'></i></td><td class='activity-cell'>"+r.activity+"</td><td class='icon-cell'><i class='fa fa-arrow-right'></i></td><td>"+r.postMood+"</td></tr>")})});var a,b,l,k,d;var h=$("#kfAudio");$(".activity-list").on("click",".activity-btn",function(){a=$(this).attr("id");b=$(this).html();if(a=="groupMeeting"){changeView("#audio");$.each(i.audios,function(n,o){if($.inArray(a,o.tags)>-1){$(".audio-name").html(o.title);$(".audio-total-time").html("<i class='fa fa-sun-o fa-spin'></i>");$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin");h.attr("src",o.link);$(".finish-audio").fadeIn();return false}else{$(".audio-name").html("Sorry, we've made an error! Try refreshing the page.");$(".play-pause i").removeClass("fa-pause fa-play fa-sun-o fa-spin").addClass("fa-times")}})}else{changeView("#moods")}$(".upcoming-activity").html(b)});$("#preMoodList").on("click",".mood-btn",function(){changeView("#audio");k=$(this).attr("id");d=$(this).html();$.each(i.audios,function(n,o){if($.inArray(a,o.tags)>-1&&$.inArray(k,o.tags)>-1){$(".audio-name").html(o.title);$(".audio-total-time").html("<i class='fa fa-sun-o fa-spin'></i>");$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin");h.attr("src",o.link);h.load();return false}else{$(".audio-name").html("Sorry, we've made an error! Try refreshing the page.");$(".play-pause i").removeClass("fa-pause fa-play fa-sun-o fa-spin").addClass("fa-times")}})});$(".cancel-audio").click(function(){changeView("#mindfulness");resetAudioPlayer()});h.on("canplay",function(n){n.stopImmediatePropagation();$(".audio-total-time").html(formatSeconds(this.duration));$(".play-pause i").removeClass("fa-sun-o fa-spin fa-pause").addClass("fa-play")});$(".play-pause").click(function(o){o.preventDefault;var n=h.get(0);if(n.paused==false){n.pause();$(".play-pause i").removeClass("fa-pause fa-rotate-left").addClass("fa-play")}else{n.play();$(".play-pause i").removeClass("fa-play fa-rotate-left").addClass("fa-pause")}});$(".seekbar").mouseover(function(){$(this).css("cursor","pointer")});$(".seekbar").click(function(r){var o=h.get(0);var n=r.pageX-$(this).offset().left;var p=$(this).width();var q=o.duration;o.currentTime=n/p*q});h.on("timeupdate",function(){$(".audio-played-time").html(formatSeconds(this.currentTime));$(".audio-progress").width(this.currentTime/this.duration*100+"%")});h.on("ended",function(){if(a!="groupMeeting"){changeView("#postAudioMood")}else{$(".play-pause i").removeClass("fa-play").addClass("fa-rotate-left")}});$("#postAudioMoodList").on("click",".mood-btn",function(){var s=$(this).html();var p="https://hooks.slack.com/services/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";var y="*"+j.name+"* ("+g.email+") just listened to an audio. Activity: _"+b+"_, Starting Mood: _"+d+"_, Finishing mood: _"+s+"_";$.ajax({data:"payload="+JSON.stringify({text:y}),dataType:"json",processData:false,type:"POST",url:p});var z={};var x=h.get(0);var u=Date.now();var o=streakCalc(u,j.streakDate,j.streak);var n=j.totalAudioTime+x.duration*1000;var v=j.totalSessions+1;var q={date:u,preMood:d,activity:b,activityID:a,postMood:s};z["/users/"+c+"/streak"]=o;z["/users/"+c+"/streakDate"]=u;z["/users/"+c+"/totalAudioTime"]=n;z["/users/"+c+"/totalSessions"]=v;z["/users/"+c+"/history/"+u]=q;var t=j.stats;t.startingMood[d]=(t.startingMood[d]||0)+1;t.activity[b]=(t.activity[b]||0)+1;t.endingMood[s]=(t.endingMood[s]||0)+1;try{firebase.database().ref().update(z);firebase.database().ref("/users/"+c+"/stats/").set(t);changeView("#analytics");resetAudioPlayer()}catch(w){console.log(w);var r="*"+j.name+"* ("+g.email+") encountered the following error: _"+w+"_";$.ajax({data:"payload="+JSON.stringify({text:r}),dataType:"json",processData:false,type:"POST",url:p})}})}})});function resetAudioPlayer(){$("#kfAudio").get(0).pause();$("#kfAudio").attr("src","");$(".audio-played-time").html("00:00");$("#audioTotalTime").html("00:00");$(".audio-progress").css("width","0%");$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin");$(".finish-audio").hide()}function checkFrequency(e){var f;var c=Object.keys(e).length;Object.keys(e).forEach(function(a){if(!f){f=e[a]}else{if(f<e[a]){f=e[a]}}});filteredKeys=Object.keys(e).filter(function(a){return e[a]==f});if(filteredKeys.length==c){var b="N/A"}else{if(filteredKeys.length>1){var b="";for(var d=0;d<filteredKeys.length;d++){b+=filteredKeys[d];if(d===filteredKeys.length-1){break}else{b+=", "}}}else{var b=filteredKeys}}return b};