$(document).ready(function(){firebase.auth().onAuthStateChanged(function(g){if(!g){$(".user-logged-in").hide();$(".user-logged-out").fadeIn();c="Nobody!";$(".user-email").html("")}else{$(".user-logged-out").hide();$(".user-logged-in").fadeIn();var c=g.uid;var j;var m;var i;var f=firebase.database().ref("users/"+c+"/organisation");f.once("value").then(function(o){m=o.val();const n=firebase.database().ref("/data");n.on("value",function(p){i=p.val();$(".activity-list").empty();$(".mood-list").empty();$.each(i.activities,function(q,r){if($.inArray(m,r.tags)>-1){$(".activity-list").append("<li><button id="+r.id+" class='btn btn-outline activity-btn'>"+r.title+"</button></li>")}});$.each(i.moods,function(q,r){$(".mood-list").append("<li><button class='btn btn-outline mood-btn' id='"+r.id+"'>"+r.name+"</button></li>")})})});var e=firebase.database().ref("users/"+c);e.on("value",function(n){j=n.val();$("#historyList").empty();$(".user-email").html(j.name);$("#totalAudioTime").html(formatMilliseconds(j.totalAudioTime));$("#totalSessions").html(j.totalSessions);$("#streak").html(j.streak);$("#frequentActivity").html(checkFrequency(j.stats.activity));$("#startingMood").html(checkFrequency(j.stats.startingMood));$("#endingMood").html(checkFrequency(j.stats.endingMood));$.each(j.history,function(p,r){var o=r.date;var q=new Date(o).toDateString();$("#historyList").append("<li><p><em>"+q+"</em></p> "+r.preMood+" <i class='fa fa-plus icon-left icon-right'></i> "+r.activity+" <i class='fa fa-arrow-right icon-left icon-right'></i> "+r.postMood+"</li>")})});var a,b,l,k,d;var h=$("#kfAudio");$(".activity-list").on("click",".activity-btn",function(){a=$(this).attr("id");b=$(this).html();if(a=="groupMeeting"){changeView("#audio");$.each(i.audios,function(n,o){if($.inArray(a,o.tags)>-1){$(".audio-name").html(o.title);$(".audio-total-time").html("<i class='fa fa-sun-o fa-spin'></i>");$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin");h.attr("src",o.link);$(".finish-audio").fadeIn();return false}else{$(".audio-name").html("Sorry, we've made an error! Try refreshing the page.");$(".play-pause i").removeClass("fa-pause fa-play fa-sun-o fa-spin").addClass("fa-times")}})}else{changeView("#moods")}$(".upcoming-activity").html(b)});$("#preMoodList").on("click",".mood-btn",function(){changeView("#audio");k=$(this).attr("id");d=$(this).html();$.each(i.audios,function(n,o){if($.inArray(a,o.tags)>-1&&$.inArray(k,o.tags)>-1){$(".audio-name").html(o.title);$(".audio-total-time").html("<i class='fa fa-sun-o fa-spin'></i>");$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin");h.attr("src",o.link);return false}else{$(".audio-name").html("Sorry, we've made an error! Try refreshing the page.");$(".play-pause i").removeClass("fa-pause fa-play fa-sun-o fa-spin").addClass("fa-times")}})});$(".cancel-audio").click(function(){changeView("#mindfulness");resetAudioPlayer()});h.on("canplay",function(n){n.stopImmediatePropagation();$(".audio-total-time").html(formatSeconds(this.duration));$(".play-pause i").removeClass("fa-sun-o fa-spin fa-pause").addClass("fa-play")});$(".play-pause").click(function(o){o.preventDefault;var n=h.get(0);if(n.paused==false){n.pause();$(".play-pause i").removeClass("fa-pause fa-rotate-left").addClass("fa-play")}else{n.play();$(".play-pause i").removeClass("fa-play fa-rotate-left").addClass("fa-pause")}});$(".seekbar").mouseover(function(){$(this).css("cursor","pointer")});$(".seekbar").click(function(r){var o=h.get(0);var n=r.pageX-$(this).offset().left;var p=$(this).width();var q=o.duration;o.currentTime=n/p*q});h.on("timeupdate",function(){$(".audio-played-time").html(formatSeconds(this.currentTime));$(".audio-progress").width(this.currentTime/this.duration*100+"%")});h.on("ended",function(){if(a!="groupMeeting"){changeView("#postAudioMood")}else{$(".play-pause i").removeClass("fa-play").addClass("fa-rotate-left")}});$("#postAudioMoodList").on("click",".mood-btn",function(){var q=$(this).html();var x={};var v=h.get(0);var s=Date.now();var o=streakCalc(s,j.streakDate,j.streak);var n=j.totalAudioTime+v.duration*1000;var t=j.totalSessions+1;var w=new Date;var p={date:s,preMood:d,activity:b,activityID:a,postMood:q};x["/users/"+c+"/streak"]=o;x["/users/"+c+"/streakDate"]=s;x["/users/"+c+"/totalAudioTime"]=n;x["/users/"+c+"/totalSessions"]=t;x["/users/"+c+"/history/"+w]=p;var r=j.stats;r.startingMood[d]=(r.startingMood[d]||0)+1;r.activity[b]=(r.activity[b]||0)+1;r.endingMood[q]=(r.endingMood[q]||0)+1;try{firebase.database().ref().update(x);firebase.database().ref("/users/"+c+"/stats/").set(r);changeView("#analytics");resetAudioPlayer()}catch(u){console.log(u)}})}})});function resetAudioPlayer(){$("#kfAudio").get(0).pause();$("#kfAudio").attr("src","");$(".audio-played-time").html("00:00");$("#audioTotalTime").html("00:00");$(".audio-progress").css("width","0%");$(".play-pause i").removeClass("fa-pause fa-play fa-times").addClass("fa-sun-o fa-spin");$(".finish-audio").hide()}function checkFrequency(e){var f;var c=Object.keys(e).length;Object.keys(e).forEach(function(a){if(!f){f=e[a]}else{if(f<e[a]){f=e[a]}}});filteredKeys=Object.keys(e).filter(function(a){return e[a]==f});if(filteredKeys.length==c){var b="N/A"}else{if(filteredKeys.length>1){var b="";for(var d=0;d<filteredKeys.length;d++){b+=filteredKeys[d];if(d===filteredKeys.length-1){break}else{b+=", "}}}else{var b=filteredKeys}}return b};